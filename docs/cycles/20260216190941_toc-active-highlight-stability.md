# ToC ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ©ã‚¤ãƒˆå®‰å®šåŒ–

**Cycle ID:** `20260216190941` **Started:** 2026-02-16 19:09:41 **Status:** ğŸŸ¡
Planning

---

## ğŸ“ What & Why

ToCã®è¦‹å‡ºã—ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºãŒä¸å®‰å®šã€‚ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸç›´å¾Œã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŒå­˜åœ¨ã—ãªã„ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã¨å‡ºç¾ã™ã‚‹ãŒä¸€ç•ªä¸Šã«æˆ»ã‚‹ã¨æ¶ˆãˆã‚‹å•é¡Œã‚’ä¿®æ­£ã™ã‚‹ã€‚

## ğŸ¯ Goals

- ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ç›´å¾Œã«æœ€åˆã®è¦‹å‡ºã—ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹ã“ã¨
- ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¦ã‚‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŒæ¶ˆãˆãªã„ã“ã¨
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é•·ã•ã«é–¢ã‚ã‚‰ãšå®‰å®šã—ãŸæŒ™å‹•ã‚’ã™ã‚‹ã“ã¨

## ğŸ” Root Cause Analysis

### æ ¹æœ¬åŸå› : IntersectionObserver ã® rootMargin è¨­å®š

**ç¾åœ¨ã®è¨­å®š:**

```typescript
rootMargin: "-10% 0px -80% 0px";
```

ã“ã‚Œã¯ã€Œãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä¸Šéƒ¨10%ã€œä¸‹éƒ¨20%ã€ã®ç¯„å›²ã§ã®ã¿è¦‹å‡ºã—ã‚’æ¤œå‡ºã™ã‚‹æ„å‘³ã€‚

**å•é¡Œ1: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ç›´å¾Œã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŒè¡¨ç¤ºã•ã‚Œãªã„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DocumentHeader (ã‚¿ãƒ–ãƒãƒ¼)       â”‚
â”‚                                   â”‚
â”‚   â”€â”€ ä¸Šéƒ¨10%ãƒ©ã‚¤ãƒ³ â”€â”€           â”‚ â† IntersectionObserver æ¤œå‡ºé–‹å§‹ä½ç½®
â”‚                                   â”‚
â”‚   # æœ€åˆã®è¦‹å‡ºã—                  â”‚ â† ã“ã“ãŒä¸Šéƒ¨10%ãƒ©ã‚¤ãƒ³ã‚ˆã‚Šä¸Šã«ã‚ã‚‹å ´åˆã€
â”‚                                   â”‚    isIntersecting = false ã«ãªã‚‹
â”‚   æœ¬æ–‡...                         â”‚
â”‚                                   â”‚
â”‚   â”€â”€ ä¸‹éƒ¨20%ãƒ©ã‚¤ãƒ³ â”€â”€           â”‚ â† IntersectionObserver æ¤œå‡ºçµ‚äº†ä½ç½®
â”‚                                   â”‚
â”‚   ## æ¬¡ã®è¦‹å‡ºã—                   â”‚ â† æ¤œå‡ºç¯„å›²å¤–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ãƒšãƒ¼ã‚¸å…ˆé ­ã®è¦‹å‡ºã—ãŒãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä¸Šéƒ¨10%ã®ã€Œãƒ‡ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³ã€å†…ã«ã‚ã‚‹ã¨ã€`isIntersecting = false`
â†’ `visibleHeadings = []` â†’ `activeId` ãŒæ›´æ–°ã•ã‚Œãªã„ã€‚

**å•é¡Œ2: ä¸€ç•ªä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã™ã‚‹ã¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŒæ¶ˆãˆã‚‹**

ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã«æˆ»ã‚‹ã¨ã€æœ€åˆã®è¦‹å‡ºã—ãŒå†ã³ãƒ‡ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³ã«å…¥ã‚‹ãŸã‚
`visibleHeadings = []` ã«ãªã‚‹ã€‚ç¾åœ¨ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ `visibleHeadings.length > 0`
ã®å ´åˆã®ã¿ `activeId`
ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€ã©ã®è¦‹å‡ºã—ã‚‚æ¤œå‡ºã•ã‚Œãªã„ã¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ãŒãã®ã¾ã¾æ®‹ã‚‹ï¼ˆï¼å‰ã®è¦‹å‡ºã—IDã®ã¾ã¾ï¼‰ãŒã€ãã®è¦‹å‡ºã—ã¯ç”»é¢ã«è¦‹ãˆã¦ã„ãªã„ãŸã‚å®Ÿè³ªçš„ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆãŒã€Œæ¶ˆãˆãŸã€ã‚ˆã†ã«è¦‹ãˆã‚‹ã€‚

**å•é¡Œ3: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®é•·ã•ã§æŒ™å‹•ãŒå¤‰ã‚ã‚‹**

- çŸ­ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: è¦‹å‡ºã—ãŒã™ã¹ã¦ä¸Šéƒ¨ã«é›†ä¸­ â†’ ãƒ‡ãƒƒãƒ‰ã‚¾ãƒ¼ãƒ³ã®å½±éŸ¿å¤§
- é•·ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: è¦‹å‡ºã—ãŒåºƒç¯„å›²ã«æ•£ã‚‰ã°ã‚‹ â†’ æ¤œå‡ºç¯„å›²ã«å…¥ã‚Šã‚„ã™ã„

**å•é¡Œ4: ç´°ã‹ã„ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŒä¸€ç¬æ¶ˆãˆã‚‹ï¼ˆã‚®ãƒ£ãƒƒãƒ—å•é¡Œï¼‰**

IntersectionObserverã® `entries` ã¯**å¤‰åŒ–ãŒã‚ã£ãŸã‚¨ãƒ³ãƒˆãƒªã®ã¿**æ¸¡ã•ã‚Œã‚‹ã€‚
ã‚†ã£ãã‚Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã¨ã€è¦‹å‡ºã—AãŒæ¤œå‡ºç¯„å›²ã‹ã‚‰å‡ºãŸæ™‚ã«
`entries = [{A, NOT intersecting}]` â†’ `visibleHeadings = []`
ã¨ãªã‚‹ãŒã€ç¾åœ¨ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯ `visibleHeadings.length > 0` ã®æ™‚ã—ã‹ `activeId`
ã‚’æ›´æ–°ã—ãªã„ãŸã‚ã€å‰ã®å€¤ï¼ˆAï¼‰ãŒãã®ã¾ã¾æ®‹ã‚‹ã€‚

ã—ã‹ã—è¦‹å‡ºã—Aã¯æ—¢ã«ç”»é¢ä¸Šéƒ¨ã«æ¶ˆãˆã¦ã„ã‚‹ã®ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œã©ã“ã‚‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã˜ã‚ƒãªã„ã€ã‚ˆã†ã«è¦‹ãˆã‚‹ç¬é–“ãŒç™ºç”Ÿã™ã‚‹ã€‚
è¦‹å‡ºã—BãŒã¾ã æ¤œå‡ºç¯„å›²ã«å…¥ã£ã¦ã„ãªã„é–“ãŒã‚®ãƒ£ãƒƒãƒ—æœŸé–“ã¨ãªã‚‹ã€‚

```
Timeline:
  è¦‹å‡ºã—A: â”â”â”â”â”â”â”â”“ï¼ˆæ¤œå‡ºç¯„å›²ã‹ã‚‰å‡ºãŸï¼‰
                     â”ƒ â† ã‚®ãƒ£ãƒƒãƒ—æœŸé–“ï¼ˆactiveIdã¯Aã ãŒç”»é¢ã‹ã‚‰è¦‹ãˆãªã„ï¼‰
  è¦‹å‡ºã—B:           â”—â”â”â”â”â”â”â”ï¼ˆæ¤œå‡ºç¯„å›²ã«å…¥ã£ãŸï¼‰
```

â†’ **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¤‰æ›´2ï¼‰ã§è§£æ±º**: `visibleHeadings.length === 0` æ™‚ã«
ã€Œã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚ˆã‚Šä¸Šã«ã‚ã‚‹æœ€å¾Œã®è¦‹å‡ºã—ã€ã‚’æ¢ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ãŸã‚ã€ã‚®ãƒ£ãƒƒãƒ—æœŸé–“ä¸­ã‚‚æ­£ã—ã„è¦‹å‡ºã—ãŒãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã‚‹ã€‚

## ğŸ“ Design

### ä¿®æ­£æ–¹é‡

**ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: IntersectionObserver + åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¨­å®š +
ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯**

3ã¤ã®æ”¹å–„ã‚’çµ„ã¿åˆã‚ã›ã‚‹:

1. **åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¨­å®š**:
   ObserveråˆæœŸåŒ–æ™‚ã«ã€æœ€åˆã®è¦‹å‡ºã—ã‚’æ˜ç¤ºçš„ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«è¨­å®š
2. **rootMarginèª¿æ•´**: ä¸Šéƒ¨ãƒãƒ¼ã‚¸ãƒ³ã‚’ `-10%` â†’ `0px`
   ã«å¤‰æ›´ã—ã€DocumentHeaderåˆ†ã®ã¿å›ºå®šå€¤ã§é™¤å¤–
3. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†**: `visibleHeadings.length === 0`
   ã®å ´åˆã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‹ã‚‰æœ€ã‚‚è¿‘ã„ã€Œæ—¢ã«é€šéã—ãŸã€è¦‹å‡ºã—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹

### Files to Change

```
src/
  ui-components/markdown/TableOfContents/
    TableOfContents.tsx       - IntersectionObserveræ”¹å–„ã€åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¨­å®š
    TableOfContents.test.tsx  - æ–°ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹è¿½åŠ 
tests/e2e/
    toc-ux.spec.ts            - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ©ã‚¤ãƒˆE2Eãƒ†ã‚¹ãƒˆè¿½åŠ 
```

### Key Points

- **rootMarginå¤‰æ›´**: `-10% 0px -80% 0px` â†’ `-40px 0px -70% 0px`
  - ä¸Šéƒ¨:
    DocumentHeaderã®é«˜ã•åˆ†ï¼ˆç´„40pxï¼‰ã®ã¿é™¤å¤–ã€‚å‰²åˆã§ã¯ãªãå›ºå®šå€¤ã§ãƒ–ãƒ¬ã‚’æ’é™¤
  - ä¸‹éƒ¨: `-80%` â†’ `-70%`
    ã«ç·©å’Œã€‚æ¤œå‡ºç¯„å›²ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä¸Šéƒ¨30%ã«æ‹¡å¤§ã—ã€è¦‹å‡ºã—ã‚’æ‹¾ã„ã‚„ã™ãã™ã‚‹
- **åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¨­å®š**: IntersectionObserverç™»éŒ²ç›´å¾Œã« `requestAnimationFrame`
  ã§æœ€åˆã®è¦‹å‡ºã—ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦è¨­å®š
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯**: `visibleHeadings.length === 0`
  æ™‚ã€å…¨è¦‹å‡ºã—ã®ã†ã¡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚ˆã‚Šä¸Šã«ã‚ã‚‹æœ€å¾Œã®è¦‹å‡ºã—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«

### å®Ÿè£…è©³ç´°

#### å¤‰æ›´1: rootMarginèª¿æ•´

```typescript
// Before
rootMargin: "-10% 0px -80% 0px";

// After
rootMargin: "-40px 0px -70% 0px";
```

- ä¸Šéƒ¨ãƒãƒ¼ã‚¸ãƒ³: `-10%`ï¼ˆãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä¾å­˜ã§ãƒ–ãƒ¬ã‚‹ï¼‰â†’
  `-40px`ï¼ˆDocumentHeaderé«˜ã•ã®å›ºå®šå€¤ï¼‰
- ä¸‹éƒ¨ãƒãƒ¼ã‚¸ãƒ³: `-80%` â†’ `-70%`ï¼ˆæ¤œå‡ºç¯„å›²ã‚’ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä¸Šéƒ¨30%ã«æ‹¡å¤§ï¼‰

#### å¤‰æ›´2: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 

```typescript
const observer = new IntersectionObserver(
  (entries) => {
    if (isUserClick) return;

    const visibleHeadings = entries
      .filter((entry) => entry.isIntersecting)
      .map((entry) => ({
        id: entry.target.id,
        top: entry.boundingClientRect.top,
      }))
      .sort((a, b) => a.top - b.top);

    if (visibleHeadings.length > 0) {
      setActiveId(visibleHeadings[0].id);
    } else {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç”»é¢å¤–ã®è¦‹å‡ºã—ã®ã†ã¡ã€
      // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä¸Šéƒ¨ã‚ˆã‚Šä¸Šã«ã‚ã‚‹æœ€å¾Œã®è¦‹å‡ºã—ï¼ˆ=æœ€è¿‘é€šéã—ãŸè¦‹å‡ºã—ï¼‰
      const allHeadings = document.querySelectorAll("h1, h2, h3");
      let lastPassedId = "";
      for (const heading of allHeadings) {
        const rect = heading.getBoundingClientRect();
        if (rect.top < 40) { // DocumentHeaderé«˜ã•åˆ†
          lastPassedId = heading.id;
        }
      }
      if (lastPassedId) {
        setActiveId(lastPassedId);
      }
    }
  },
  { rootMargin: "-40px 0px -70% 0px" },
);
```

#### å¤‰æ›´3: åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–è¨­å®š

```typescript
// Observerç™»éŒ²å¾Œã€DOMãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®Œäº†ã‚’å¾…ã£ã¦åˆæœŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’è¨­å®š
requestAnimationFrame(() => {
  const allHeadings = document.querySelectorAll("h1, h2, h3");
  if (allHeadings.length > 0 && !isUserClick) {
    // ãƒšãƒ¼ã‚¸ãƒˆãƒƒãƒ—ã®å ´åˆã¯æœ€åˆã®è¦‹å‡ºã—
    const firstHeading = allHeadings[0];
    const rect = firstHeading.getBoundingClientRect();
    if (rect.top >= 0 && rect.top < globalThis.innerHeight) {
      setActiveId(firstHeading.id);
    }
  }
});
```

## âœ… Tests

### Unit Tests (TableOfContents.test.tsx)

- [x] åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°æ™‚ã«æœ€åˆã®è¦‹å‡ºã—ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚‹ã“ã¨ï¼ˆIntersectionObserverãƒ¢ãƒƒã‚¯æ”¹å–„ï¼‰
- [x] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§é€šéæ¸ˆã¿è¦‹å‡ºã—ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚‹ã“ã¨

### E2E Tests (toc-ux.spec.ts)

- [x] ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ç›´å¾Œã«ToCã®æœ€åˆã®è¦‹å‡ºã—ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [x] ãƒšãƒ¼ã‚¸æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«â†’æœ€ä¸Šéƒ¨ã«æˆ»ã£ã¦ã‚‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãŒæ¶ˆãˆãªã„ã“ã¨
- [x] ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä¸­ã«å¸¸ã«ã„ãšã‚Œã‹ã®è¦‹å‡ºã—ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ã‚ã‚‹ã“ã¨ï¼ˆã‚®ãƒ£ãƒƒãƒ—ãªã—ï¼‰

## ğŸ”’ Security

- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¸ã®å½±éŸ¿ãªã—ï¼ˆUIã®è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã®æ”¹å–„ã®ã¿ï¼‰

## ğŸ“Š Progress

| Step           | Status |
| -------------- | ------ |
| Tests          | ğŸŸ¢     |
| Implementation | ğŸŸ¢     |
| E2E Tests      | ğŸŸ¢     |
| Commit         | âšª     |

**Legend:** âšª Pending Â· ğŸŸ¡ In Progress Â· ğŸŸ¢ Done

---

**Next:** Write tests â†’ Implement â†’ Commit with `smart-commit` ğŸš€
